name: Daily Data Sync

on:
  schedule:
    - cron: "0 0 * * *" # Every day at 00:00 UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Server Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Run Build Pipeline
        run: node scripts/build_pipeline.js
        env:
          NODE_ENV: production

      - name: Extract Version Info
        id: vars
        run: |
          VERSION=$(node -e "console.log(require('./public/data.json').commit.substring(0,7))")
          DATE=$(date +'%Y-%m-%d')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: v${{ steps.vars.outputs.date }}-${{ steps.vars.outputs.version }}
          name: "Sutta Data Update - ${{ steps.vars.outputs.date }} (${{ steps.vars.outputs.version }})"
          body: |
            ### ðŸ“¦ Daily Sutta Data Bundle
            - **Data Version (Commit)**: `${{ steps.vars.outputs.version }}`
            - **Build Date**: `${{ steps.vars.outputs.date }}`

            This release contains the latest segmented texts from SuttaCentral's `bilara-data` repository.
          files: |
            public/data.zip
            public/data.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Keep only last 5 releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 5
          delete_expired_data: 30
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
